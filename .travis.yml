sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: Va0G7yDomICG8TXEOkkg3Z5/RXqI2kydNa3l2ZHN92/Oaff9TshLNt2PSVkiR+RO5McDMmBFM4wwCJvAeOO2xVzwUas97eEFt+xmK8FT91mLoO3UvElvdjGis3kg/0BcdNTGO5pCZ/yQ2QwNW4vYmegT6V/p2lJpy2gQcEjMu0PhONmIVZzI0kUQsD+7JbSRq6ZbyJhCWgUQ69cpICucvx+cKd7Kyt2dlhiWhIMdVjAemjWmr3uCGulxoNvT2Je23RhdvdcHBglHd/GdqoPCGBfv3QPUuMMOqKDlQDZ5kU5/QcOIBFatxZ7LLIvuJLQwgHW3qRgFzFE6MC9aj0+9xPJGBRvfXPHnYDYxM/zsYZEYNbnJLStiRU7o7idwgAuO4Tea3ASDXk9qWDs/6yUmLw0chygIOgxwBL/Ohd79OebG/ApYRYr+kbcFwkLLna3RrmFrse6TE9DvGHMYtBWQxiNmijFNd1jnJCPgE6jV6qOigIqYPt8RjmxQ/xE7JIYEkt1d5eGuCCHbrapGF/bRbD5M+mZ4V0Z4ROGymWoShUR90Pn9GHtXpIbRifa5zHh5k5wIoc8ougjlciHzCtfW9qT/GpGbyy8eca1sk6gclvYm8LEIGHcXNZ8/ZFYpeXo94rBW/efZdVOapO25VO4vdaKu4x5+NwbGoG0n361G/E4=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/The-Pioneers--Or-The-Sources-of-the-Susquehanna_2275
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy